@page "/prepare-hybrid-data"
@using BlazorApp.Services.Data
@using BlazorApp.Services.Embeddings
@using System.Text.Json
@using System.Text.Json.Nodes
@inject IHybridFileService FileService
@inject IEmbeddingService EmbeddingService
@rendermode InteractiveServer

<PageTitle>Prepare Hybrid Data</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-database-gear"></i> Prepare Hybrid Data</h1>
            <p class="text-muted">
                This tool reads JSON files from <code>data/hybrid</code>, generates embeddings for the 
                <code>description</code> field using Azure OpenAI, and saves the result back to the file.
            </p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Status</h5>
                    
                    @if (_isProcessing)
                    {
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @(_progressPercentage)%;" 
                                 aria-valuenow="@_processedCount" 
                                 aria-valuemin="0" 
                                 aria-valuemax="@_totalFiles">
                                @_processedCount / @_totalFiles
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Processing: <strong>@_currentFile</strong>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>Total Files:</strong> @_totalFiles <br/>
                                <strong>Processed:</strong> @_processedCount
                            </div>
                            <button class="btn btn-primary btn-lg" @onclick="StartProcessing" disabled="@(_totalFiles == 0)">
                                <i class="bi bi-play-fill"></i> Generate Embeddings
                            </button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_statusMessage))
                    {
                        <div class="alert alert-@_statusType mt-3">
                            @_statusMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h5>File List</h5>
            <div class="list-group overflow-auto" style="max-height: 400px;">
                @foreach (var file in _files)
                {
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@file</span>
                        @if (_processedFiles.Contains(file))
                        {
                            <span class="badge bg-success"><i class="bi bi-check"></i> Done</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Pending</span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<string> _files = new();
    private HashSet<string> _processedFiles = new();
    private bool _isProcessing = false;
    private int _totalFiles = 0;
    private int _processedCount = 0;
    private double _progressPercentage => _totalFiles > 0 ? (double)_processedCount / _totalFiles * 100 : 0;
    private string _currentFile = "";
    private string _statusMessage = "";
    private string _statusType = "info"; // info, success, danger

    protected override async Task OnInitializedAsync()
    {
        await LoadFilesAsync();
    }

    private async Task LoadFilesAsync()
    {
        try
        {
            _files = await FileService.ListFilesAsync();
            _totalFiles = _files.Count;
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error loading files: {ex.Message}";
            _statusType = "danger";
        }
    }

    private async Task StartProcessing()
    {
        if (_isProcessing) return;

        _isProcessing = true;
        _processedCount = 0;
        _processedFiles.Clear();
        _statusMessage = "";

        try
        {
            foreach (var file in _files)
            {
                _currentFile = file;
                StateHasChanged(); // Update UI

                // 1. Read File
                string content = await FileService.ReadFileAsync(file);
                var jsonNode = JsonNode.Parse(content);

                if (jsonNode != null)
                {
                    // 2. Get Description
                    string description = jsonNode["description"]?.ToString() ?? "";

                    if (!string.IsNullOrWhiteSpace(description))
                    {
                        // 3. Generate Embedding
                        var embedding = await EmbeddingService.GenerateEmbeddingAsync(description);

                        // 4. Update JSON
                        // Convert ReadOnlyMemory<float> to array for JSON serialization
                        var embeddingArray = embedding.ToArray();
                        
                        // Add or Update descriptionVector field
                        jsonNode["descriptionVector"] = JsonNode.Parse(JsonSerializer.Serialize(embeddingArray));

                        // 5. Save File
                        await FileService.SaveFileAsync(file, jsonNode.ToJsonString(new JsonSerializerOptions { WriteIndented = true }));
                    }
                }

                _processedCount++;
                _processedFiles.Add(file);
                StateHasChanged();
                
                // Small delay to allow UI to render and prevent complete thread blocking
                await Task.Delay(50); 
            }

            _statusMessage = "Successfully processed all files!";
            _statusType = "success";
        }
        catch (Exception ex)
        {
            _statusMessage = $"Error processing {_currentFile}: {ex.Message}";
            _statusType = "danger";
        }
        finally
        {
            _isProcessing = false;
            _currentFile = "";
        }
    }
}
